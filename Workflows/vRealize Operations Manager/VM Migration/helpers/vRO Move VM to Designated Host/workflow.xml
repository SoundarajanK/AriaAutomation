<?xml version='1.0' encoding='UTF-8'?>
<workflow xmlns="http://vmware.com/vco/workflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://vmware.com/vco/workflow http://vmware.com/vco/workflow/Workflow-v4.xsd" root-name="item4" object-name="workflow:name=generic" id="5fd281e6-0631-499d-8ba1-04ca7ce8fc5a" version="0.0.25" api-version="6.0.0" allowed-operations="evf" restartMode="1" resumeFromFailedMode="0">
  <display-name><![CDATA[vRO Move VM to Designated Host]]></display-name>
  <position y="0.0" x="65.0"/>
  <input>
    <param name="targetId" type="string">
      <description><![CDATA[The Uuid of the VM to modify]]></description>
    </param>
    <param name="correlationId" type="string">
      <description><![CDATA[The correlationId for the workflow used for logging purposes. ]]></description>
    </param>
    <param name="targetvCenteruuid" type="string">
      <description><![CDATA[UUID of the vCenter where the target VM resides]]></description>
    </param>
    <param name="targetHostId" type="string">
      <description><![CDATA[MOID of the vimHost for migration target]]></description>
    </param>
  </input>
  <output>
    <param name="STATUS" type="string"/>
  </output>
  <attrib name="status" type="boolean" read-only="false">
    <value encoded="n"><![CDATA[false]]></value>
  </attrib>
  <attrib name="eventOut" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="eventDetails" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="targetVmName" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="targetVM" type="VC:VirtualMachine" read-only="false">
    <value encoded="n"><![CDATA[__NULL__]]></value>
  </attrib>
  <attrib name="severity" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="targetHost" type="VC:HostSystem" read-only="false">
    <value encoded="n"><![CDATA[__NULL__]]></value>
  </attrib>
  <attrib name="priority" type="VC:VirtualMachineMovePriority" read-only="false">
    <value encoded="n"><![CDATA[dunes://service.dunes.ch/CustomSDKObject?id='highPriority'&dunesName='VC:VirtualMachineMovePriority']]></value>
    <description><![CDATA[Priority of the migration task]]></description>
  </attrib>
  <attrib name="pool" type="VC:ResourcePool" read-only="false">
    <value encoded="n"><![CDATA[__NULL__]]></value>
    <description><![CDATA[Destination resource pool for the virtual machine. If you do not set the resource pool parameter, the current resource pool is used as the destination pool]]></description>
  </attrib>
  <attrib name="state" type="VC:VirtualMachinePowerState" read-only="false">
    <value encoded="n"><![CDATA[__NULL__]]></value>
    <description><![CDATA[(Optional) Only migrate the virtual machine if its power on state matches the specified state]]></description>
  </attrib>
  <attrib name="targetVMArray" type="Array/VC:VirtualMachine" read-only="false">
    <value encoded="n"><![CDATA[__NULL__]]></value>
  </attrib>
  <attrib name="targetHostArray" type="Array/VC:HostSystem" read-only="false">
    <value encoded="n"><![CDATA[__NULL__]]></value>
  </attrib>
  <attrib name="errorsAndWarnings" type="Array/string" read-only="false">
    <value encoded="n"><![CDATA[__NULL__]]></value>
  </attrib>
  <attrib name="targetVcenterConnection" type="VC:SdkConnection" read-only="false">
    <value encoded="n"><![CDATA[__NULL__]]></value>
  </attrib>
  <workflow-note x="40.0" y="0.0" w="880.0" h="147.0" color="a1d7a1ff">
    <description><![CDATA[Validation and Common Starting Tasks]]></description>
  </workflow-note>
  <workflow-item name="item1" out-name="item2" type="link" linked-workflow-id="ec1a8692-4711-4b73-8de4-e342131a6cb7">
    <display-name><![CDATA[ValidateTarget]]></display-name>
    <in-binding>
      <bind name="targetId" type="string" export-name="targetId"/>
      <bind name="correlationId" type="string" export-name="correlationId"/>
    </in-binding>
    <out-binding>
      <bind name="status" type="boolean" export-name="status"/>
      <bind name="eventOut" type="string" export-name="eventOut"/>
      <bind name="eventDetails" type="string" export-name="eventDetails"/>
    </out-binding>
    <position y="9.954545454545453" x="264.5"/>
  </workflow-item>
  <workflow-item name="item2" out-name="item16" type="condition" alt-out-name="item19" comparator="0">
    <display-name><![CDATA[Valid Target Id]]></display-name>
    <script encoded="false"><![CDATA[//Generated by the system, cannot be edited
return (status == true) ;]]></script>
    <in-binding>
      <bind name="status" type="boolean" export-name="status"/>
    </in-binding>
    <condition name="status" type="boolean" comparator="0" label="null">false</condition>
    <position y="0.0" x="385.0"/>
  </workflow-item>
  <workflow-item name="item5" out-name="item10" type="condition" alt-out-name="item0" comparator="0">
    <display-name><![CDATA[Target VM Found]]></display-name>
    <script encoded="false"><![CDATA[//Generated by the system, cannot be edited
return (status == true) ;]]></script>
    <in-binding>
      <bind name="status" type="boolean" export-name="status"/>
    </in-binding>
    <condition name="status" type="boolean" comparator="0" label="null">false</condition>
    <position y="0.0" x="804.5"/>
  </workflow-item>
  <workflow-item name="item18" out-name="item3" type="link" linked-workflow-id="161f7106-481b-453b-9e10-cc29acd42fef">
    <display-name><![CDATA[EventRecorder]]></display-name>
    <in-binding>
      <bind name="event" type="string" export-name="eventOut"/>
      <bind name="eventDetails" type="string" export-name="eventDetails"/>
      <bind name="CorrelationId" type="string" export-name="correlationId"/>
      <bind name="targetVMName" type="string" export-name="targetVmName"/>
      <bind name="severity" type="string" export-name="severity"/>
    </in-binding>
    <out-binding/>
    <position y="64.5" x="684.5"/>
  </workflow-item>
  <workflow-item name="item24" out-name="item30" type="link" linked-workflow-id="161f7106-481b-453b-9e10-cc29acd42fef">
    <display-name><![CDATA[EventRecorder]]></display-name>
    <in-binding>
      <bind name="event" type="string" export-name="eventOut"/>
      <bind name="eventDetails" type="string" export-name="eventDetails"/>
      <bind name="CorrelationId" type="string" export-name="correlationId"/>
      <bind name="targetVMName" type="string" export-name="targetVmName"/>
      <bind name="severity" type="string" export-name="severity"/>
    </in-binding>
    <out-binding/>
    <position y="173.59090909090907" x="1384.5"/>
  </workflow-item>
  <workflow-item name="item4" out-name="item1" type="task">
    <display-name><![CDATA[Status Running]]></display-name>
    <script encoded="false"><![CDATA[STATUS = "Running";
eventOut = " ";
eventDetails = " ";
severity = " ";]]></script>
    <in-binding/>
    <out-binding>
      <bind name="STATUS" type="string" export-name="STATUS"/>
      <bind name="eventDetails" type="string" export-name="eventDetails"/>
      <bind name="eventOut" type="string" export-name="eventOut"/>
      <bind name="severity" type="string" export-name="severity"/>
    </out-binding>
    <position y="9.954545454545453" x="145.0"/>
  </workflow-item>
  <workflow-item name="item19" out-name="item18" type="task">
    <display-name><![CDATA[Status Failed]]></display-name>
    <script encoded="false"><![CDATA[STATUS = "Failed";
eventOut = "Validate Target";
eventDetails = "Not a valid UUID";
severity = "error";]]></script>
    <in-binding/>
    <out-binding>
      <bind name="STATUS" type="string" export-name="STATUS"/>
      <bind name="severity" type="string" export-name="severity"/>
      <bind name="eventOut" type="string" export-name="eventOut"/>
      <bind name="eventDetails" type="string" export-name="eventDetails"/>
    </out-binding>
    <position y="64.5" x="385.0"/>
  </workflow-item>
  <workflow-item name="item3" type="end" end-mode="0">
    <position y="109.04545454545453" x="724.5"/>
  </workflow-item>
  <workflow-item name="item21" out-name="item24" type="task">
    <display-name><![CDATA[Status Success]]></display-name>
    <script encoded="false"><![CDATA[STATUS = "Success";
eventOut = "Migrate VM";
eventDetails = "VM successfully migrated";
severity = "info";
]]></script>
    <in-binding/>
    <out-binding>
      <bind name="STATUS" type="string" export-name="STATUS"/>
      <bind name="eventOut" type="string" export-name="eventOut"/>
      <bind name="eventDetails" type="string" export-name="eventDetails"/>
      <bind name="severity" type="string" export-name="severity"/>
    </out-binding>
    <position y="319.0454545454545" x="1104.5"/>
  </workflow-item>
  <workflow-item name="item10" out-name="item9" catch-name="item6" throw-bind-name="eventDetails" type="task">
    <display-name><![CDATA[Validate VM Host Target]]></display-name>
    <script encoded="false"><![CDATA[//extract MOID from input param
//sent from vROps as host-name|moid
var hostMoid = targetHostId.split('|')[1];
System.log("ESX Host MoId is: " + hostMoid);
targetHostId=hostMoid;

//get host object
targetHost = null;
var allHosts = VcPlugin.getAllHostSystems();
for (i = 0; i < allHosts.length; i++) {
  if (targetHostId == allHosts[i].id) {
	targetHost = allHosts[i];
	System.log("Found ESX host " + targetHost.name);
	break;
  }
}
if (!targetHost) {
  throw("No matching host ID found!");
}


]]></script>
    <in-binding>
      <bind name="targetVM" type="VC:VirtualMachine" export-name="targetVM"/>
      <bind name="targetHostId" type="string" export-name="targetHostId">
        <description><![CDATA[MOID of the vimHost for migration target]]></description>
      </bind>
    </in-binding>
    <out-binding>
      <bind name="targetHost" type="VC:HostSystem" export-name="targetHost"/>
    </out-binding>
    <position y="9.954545454545453" x="964.5"/>
  </workflow-item>
  <workflow-item name="item30" type="end" end-mode="0">
    <position y="163.59090909090907" x="1584.5"/>
  </workflow-item>
  <workflow-item name="item13" out-name="item21" catch-name="item8" throw-bind-name="eventDetails" type="link" linked-workflow-id="BD8080808080808080808080808080803DC180800122528313869552e41805bb1">
    <display-name><![CDATA[Migrate virtual machine with vMotion]]></display-name>
    <in-binding>
      <bind name="vm" type="VC:VirtualMachine" export-name="targetVM">
        <description><![CDATA[Virtual machine to migrate]]></description>
      </bind>
      <bind name="pool" type="VC:ResourcePool" export-name="pool">
        <description><![CDATA[Destination resource pool for the virtual machine. If you do not set the resource pool parameter, the current resource pool is used as the destination pool]]></description>
      </bind>
      <bind name="host" type="VC:HostSystem" export-name="targetHost">
        <description><![CDATA[Destination host to which to migrate the virtual machine]]></description>
      </bind>
      <bind name="priority" type="VC:VirtualMachineMovePriority" export-name="priority">
        <description><![CDATA[Priority of the migration task]]></description>
      </bind>
      <bind name="state" type="VC:VirtualMachinePowerState" export-name="state">
        <description><![CDATA[(Optional) Only migrate the virtual machine if its power on state matches the specified state]]></description>
      </bind>
    </in-binding>
    <out-binding/>
    <description><![CDATA[Migrates a virtual machine from one host to another by using MigrateVM_Task from the vSphere API.]]></description>
    <position y="282.68181818181813" x="964.5"/>
  </workflow-item>
  <workflow-item name="item0" out-name="item18" type="task">
    <display-name><![CDATA[Status Failed]]></display-name>
    <script encoded="false"><![CDATA[STATUS = "Failed";
eventOut = "Find VM by MOID";
eventDetails = "Could not find VM by MOID";
severity = "error";]]></script>
    <in-binding/>
    <out-binding>
      <bind name="STATUS" type="string" export-name="STATUS"/>
      <bind name="eventOut" type="string" export-name="eventOut"/>
      <bind name="eventDetails" type="string" export-name="eventDetails"/>
      <bind name="severity" type="string" export-name="severity"/>
    </out-binding>
    <position y="64.5" x="804.5"/>
  </workflow-item>
  <workflow-item name="item8" out-name="item24" type="task">
    <display-name><![CDATA[Status Failed]]></display-name>
    <script encoded="false"><![CDATA[STATUS = "Failed";
eventOut = "Migrate VM";
eventDetails = "VM Migration Failed - see VC logs";
severity = "error";]]></script>
    <in-binding/>
    <out-binding>
      <bind name="STATUS" type="string" export-name="STATUS"/>
      <bind name="eventOut" type="string" export-name="eventOut"/>
      <bind name="eventDetails" type="string" export-name="eventDetails"/>
      <bind name="severity" type="string" export-name="severity"/>
    </out-binding>
    <position y="264.5" x="1104.5"/>
  </workflow-item>
  <workflow-item name="item7" out-name="item11" type="link" linked-workflow-id="98ce1742-1f9a-4885-a979-eaf87065e5bd">
    <display-name><![CDATA[vMotion Compatibility Checker]]></display-name>
    <in-binding>
      <bind name="vm" type="Array/VC:VirtualMachine" export-name="targetVMArray"/>
      <bind name="host" type="Array/VC:HostSystem" export-name="targetHostArray"/>
      <bind name="vCenter" type="VC:SdkConnection" export-name="targetVcenterConnection"/>
    </in-binding>
    <out-binding>
      <bind name="errorsAndWarnings" type="Array/string" export-name="errorsAndWarnings"/>
    </out-binding>
    <position y="100.86363636363636" x="964.5"/>
  </workflow-item>
  <workflow-item name="item9" out-name="item7" type="task">
    <display-name><![CDATA[Arrayize]]></display-name>
    <script encoded="false"><![CDATA[//host and vm need to be in array for
//vmotion check workflow
targetVMArray=[];
targetHostArray=[];
targetVMArray.push(targetVM);
targetHostArray.push(targetHost);
]]></script>
    <in-binding>
      <bind name="targetVM" type="VC:VirtualMachine" export-name="targetVM"/>
      <bind name="targetHost" type="VC:HostSystem" export-name="targetHost"/>
    </in-binding>
    <out-binding>
      <bind name="targetVMArray" type="Array/VC:VirtualMachine" export-name="targetVMArray"/>
      <bind name="targetHostArray" type="Array/VC:HostSystem" export-name="targetHostArray"/>
    </out-binding>
    <position y="55.40909090909091" x="964.5"/>
  </workflow-item>
  <workflow-item name="item11" out-name="item17" catch-name="item14" throw-bind-name="eventDetails" type="task">
    <display-name><![CDATA[Trap Check Errors]]></display-name>
    <script encoded="false"><![CDATA[if (errorsAndWarnings.length>0) {
  throw("vMotion Check Failed - correct issues above and retry");
}

]]></script>
    <in-binding>
      <bind name="errorsAndWarnings" type="Array/string" export-name="errorsAndWarnings"/>
      <bind name="correlationId" type="string" export-name="correlationId">
        <description><![CDATA[The correlationId for the workflow used for logging purposes. ]]></description>
      </bind>
      <bind name="status" type="boolean" export-name="status"/>
    </in-binding>
    <out-binding/>
    <position y="155.4090909090909" x="964.5"/>
  </workflow-item>
  <workflow-item name="item14" out-name="item15" type="task">
    <display-name><![CDATA[Status Failed]]></display-name>
    <script encoded="false"><![CDATA[STATUS = "Failed";
eventOut = "vMotion Pre-Checks";
eventDetails = "vMotion pre-check failed. Correct issues noted above and retry.";
severity = "error";]]></script>
    <in-binding/>
    <out-binding>
      <bind name="STATUS" type="string" export-name="STATUS"/>
      <bind name="eventOut" type="string" export-name="eventOut"/>
      <bind name="eventDetails" type="string" export-name="eventDetails"/>
      <bind name="severity" type="string" export-name="severity"/>
    </out-binding>
    <position y="155.4090909090909" x="1104.5"/>
  </workflow-item>
  <workflow-item name="item15" out-name="item24" type="foreach">
    <display-name><![CDATA[Foreach (EventRecorder)]]></display-name>
    <in-binding>
      <bind name="event" type="string" export-name="eventOut"/>
      <bind name="eventDetails" type="Array/string" export-name="*errorsAndWarnings"/>
      <bind name="CorrelationId" type="string" export-name="correlationId"/>
      <bind name="targetVMName" type="string" export-name="targetVmName"/>
      <bind name="severity" type="string" export-name="severity"/>
    </in-binding>
    <out-binding/>
    <reference type="Workflow" id="161f7106-481b-453b-9e10-cc29acd42fef"/>
    <position y="155.4090909090909" x="1224.5"/>
  </workflow-item>
  <workflow-item name="item16" out-name="item12" type="link" linked-workflow-id="12e3b318-41ad-4e7a-9ac9-2ef703e81d4f">
    <display-name><![CDATA[Get vCenter Connection by UUID]]></display-name>
    <in-binding>
      <bind name="targetVcenterUuid" type="string" export-name="targetvCenteruuid"/>
    </in-binding>
    <out-binding>
      <bind name="targetVcenterConnection" type="VC:SdkConnection" export-name="targetVcenterConnection"/>
    </out-binding>
    <position y="9.954545454545453" x="524.5"/>
  </workflow-item>
  <workflow-item name="item6" out-name="item24" type="task">
    <display-name><![CDATA[set failed]]></display-name>
    <script encoded="false"><![CDATA[STATUS = "Failed";
eventOut = "Validate VM Host Target";
eventDetails = "Target Host ID Invalid or Not Found";
severity = "error";]]></script>
    <in-binding/>
    <out-binding>
      <bind name="STATUS" type="string" export-name="STATUS"/>
      <bind name="eventOut" type="string" export-name="eventOut"/>
      <bind name="eventDetails" type="string" export-name="eventDetails"/>
      <bind name="severity" type="string" export-name="severity"/>
    </out-binding>
    <position y="73.59090909090908" x="1144.5"/>
  </workflow-item>
  <workflow-item name="item12" out-name="item5" type="link" linked-workflow-id="6ff24a3a-d83e-47fd-9661-cdfbed7b7c22">
    <display-name><![CDATA[Find VM by MOID]]></display-name>
    <in-binding>
      <bind name="targetId" type="string" export-name="targetId"/>
      <bind name="CorrelationId" type="string" export-name="correlationId"/>
      <bind name="targetvCenteruuid" type="string" export-name="targetvCenteruuid">
        <description><![CDATA[UUID of the vCenter where the target VM is located]]></description>
      </bind>
    </in-binding>
    <out-binding>
      <bind name="statusOut" type="boolean" export-name="status"/>
      <bind name="targetVM" type="VC:VirtualMachine" export-name="targetVM"/>
      <bind name="targetVmName" type="string" export-name="targetVmName"/>
    </out-binding>
    <position y="9.954545454545453" x="664.5"/>
  </workflow-item>
  <workflow-item name="item17" out-name="item13" type="link" linked-workflow-id="0a41343d-d8a4-4811-8365-ccc0cf677c55">
    <display-name><![CDATA[Get Default Resource Pool]]></display-name>
    <in-binding/>
    <out-binding>
      <bind name="defaultPool" type="VC:ResourcePool" export-name="pool"/>
    </out-binding>
    <position y="219.04545454545453" x="965.0"/>
  </workflow-item>
  <presentation>
    <p-param name="correlationId">
      <desc><![CDATA[correlationId]]></desc>
      <p-qual kind="static" name="mandatory" type="boolean"><![CDATA[false]]></p-qual>
    </p-param>
    <p-param name="targetId">
      <desc><![CDATA[targetId]]></desc>
    </p-param>
    <p-param name="targetvCenteruuid">
      <desc><![CDATA[UUID of the vCenter where the target VM is located]]></desc>
    </p-param>
    <p-param name="targetHostId">
      <desc><![CDATA[MOID of the vimHost for migration target]]></desc>
    </p-param>
  </presentation>
</workflow>