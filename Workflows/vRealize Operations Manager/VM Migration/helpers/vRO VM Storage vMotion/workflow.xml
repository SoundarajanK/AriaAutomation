<?xml version='1.0' encoding='UTF-8'?>
<workflow xmlns="http://vmware.com/vco/workflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://vmware.com/vco/workflow http://vmware.com/vco/workflow/Workflow-v4.xsd" root-name="item4" object-name="workflow:name=generic" id="1f378a11-8104-4cc8-8cd6-b11e102dc30e" version="0.0.2" api-version="6.0.0" allowed-operations="evf" restartMode="1" resumeFromFailedMode="0">
  <display-name><![CDATA[vRO VM Storage vMotion]]></display-name>
  <position y="0.0" x="65.0"/>
  <input>
    <param name="targetId" type="string">
      <description><![CDATA[The Uuid of the VM to modify]]></description>
    </param>
    <param name="correlationId" type="string">
      <description><![CDATA[The correlationId for the workflow used for logging purposes. ]]></description>
    </param>
    <param name="targetvCenteruuid" type="string">
      <description><![CDATA[UUID of the vCenter where the target VM resides]]></description>
    </param>
    <param name="targetDataStoreId" type="string">
      <description><![CDATA[MOID of the Datastore target]]></description>
    </param>
  </input>
  <output>
    <param name="STATUS" type="string"/>
  </output>
  <attrib name="status" type="boolean" read-only="false">
    <value encoded="n"><![CDATA[false]]></value>
  </attrib>
  <attrib name="eventOut" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="eventDetails" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="targetVmName" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="targetVM" type="VC:VirtualMachine" read-only="false">
    <value encoded="n"><![CDATA[__NULL__]]></value>
  </attrib>
  <attrib name="severity" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="targetVcenterConnection" type="VC:SdkConnection" read-only="false">
    <value encoded="n"><![CDATA[__NULL__]]></value>
  </attrib>
  <attrib name="targetDatastore" type="VC:Datastore" read-only="false">
    <value encoded="n"><![CDATA[__NULL__]]></value>
  </attrib>
  <attrib name="targetHost" type="VC:HostSystem" read-only="false">
    <value encoded="n"><![CDATA[__NULL__]]></value>
  </attrib>
  <workflow-note x="40.0" y="0.0" w="820.0" h="147.0" color="a1d7a1ff">
    <description><![CDATA[Validation and Common Starting Tasks]]></description>
  </workflow-note>
  <workflow-item name="item1" out-name="item2" type="link" linked-workflow-id="ec1a8692-4711-4b73-8de4-e342131a6cb7">
    <display-name><![CDATA[ValidateTarget]]></display-name>
    <in-binding>
      <bind name="targetId" type="string" export-name="targetId"/>
      <bind name="correlationId" type="string" export-name="correlationId"/>
    </in-binding>
    <out-binding>
      <bind name="status" type="boolean" export-name="status"/>
      <bind name="eventOut" type="string" export-name="eventOut"/>
      <bind name="eventDetails" type="string" export-name="eventDetails"/>
    </out-binding>
    <position y="9.954545454545453" x="264.5"/>
  </workflow-item>
  <workflow-item name="item2" out-name="item7" type="condition" alt-out-name="item19" comparator="0">
    <display-name><![CDATA[Valid Target Id]]></display-name>
    <script encoded="false"><![CDATA[//Generated by the system, cannot be edited
return (status == true) ;]]></script>
    <in-binding>
      <bind name="status" type="boolean" export-name="status"/>
    </in-binding>
    <condition name="status" type="boolean" comparator="0" label="null">false</condition>
    <position y="0.0" x="385.0"/>
  </workflow-item>
  <workflow-item name="item5" out-name="item10" type="condition" alt-out-name="item0" comparator="0">
    <display-name><![CDATA[Target VM Found]]></display-name>
    <script encoded="false"><![CDATA[//Generated by the system, cannot be edited
return (status == true) ;]]></script>
    <in-binding>
      <bind name="status" type="boolean" export-name="status"/>
    </in-binding>
    <condition name="status" type="boolean" comparator="0" label="null">false</condition>
    <position y="0.0" x="764.5"/>
  </workflow-item>
  <workflow-item name="item18" out-name="item3" type="link" linked-workflow-id="161f7106-481b-453b-9e10-cc29acd42fef">
    <display-name><![CDATA[EventRecorder]]></display-name>
    <in-binding>
      <bind name="event" type="string" export-name="eventOut"/>
      <bind name="eventDetails" type="string" export-name="eventDetails"/>
      <bind name="CorrelationId" type="string" export-name="correlationId"/>
      <bind name="targetVMName" type="string" export-name="targetVmName"/>
      <bind name="severity" type="string" export-name="severity"/>
    </in-binding>
    <out-binding/>
    <position y="64.5" x="624.5"/>
  </workflow-item>
  <workflow-item name="item24" out-name="item30" type="link" linked-workflow-id="161f7106-481b-453b-9e10-cc29acd42fef">
    <display-name><![CDATA[EventRecorder]]></display-name>
    <in-binding>
      <bind name="event" type="string" export-name="eventOut"/>
      <bind name="eventDetails" type="string" export-name="eventDetails"/>
      <bind name="CorrelationId" type="string" export-name="correlationId"/>
      <bind name="targetVMName" type="string" export-name="targetVmName"/>
      <bind name="severity" type="string" export-name="severity"/>
    </in-binding>
    <out-binding/>
    <position y="164.5" x="1244.5"/>
  </workflow-item>
  <workflow-item name="item12" out-name="item5" type="link" linked-workflow-id="6ff24a3a-d83e-47fd-9661-cdfbed7b7c22">
    <display-name><![CDATA[Find VM by MOID]]></display-name>
    <in-binding>
      <bind name="targetId" type="string" export-name="targetId"/>
      <bind name="CorrelationId" type="string" export-name="correlationId"/>
      <bind name="targetvCenteruuid" type="string" export-name="targetvCenteruuid">
        <description><![CDATA[UUID of the vCenter where the target VM is located]]></description>
      </bind>
    </in-binding>
    <out-binding>
      <bind name="statusOut" type="boolean" explicitly-not-bound="true"/>
      <bind name="targetVM" type="VC:VirtualMachine" export-name="targetVM"/>
      <bind name="targetVmName" type="string" export-name="targetVmName"/>
    </out-binding>
    <position y="9.954545454545453" x="664.5"/>
  </workflow-item>
  <workflow-item name="item4" out-name="item1" type="task">
    <display-name><![CDATA[Status Running]]></display-name>
    <script encoded="false"><![CDATA[STATUS = "Running";]]></script>
    <in-binding/>
    <out-binding>
      <bind name="STATUS" type="string" export-name="STATUS"/>
    </out-binding>
    <position y="9.954545454545453" x="145.0"/>
  </workflow-item>
  <workflow-item name="item19" out-name="item18" type="task">
    <display-name><![CDATA[Status Failed]]></display-name>
    <script encoded="false"><![CDATA[STATUS = "Failed";
eventOut = "Validate Target";
eventDetails = "Not a valid UUID";
severity = "error";]]></script>
    <in-binding/>
    <out-binding>
      <bind name="STATUS" type="string" export-name="STATUS"/>
      <bind name="severity" type="string" export-name="severity"/>
      <bind name="eventOut" type="string" export-name="eventOut"/>
      <bind name="eventDetails" type="string" export-name="eventDetails"/>
    </out-binding>
    <position y="64.5" x="385.0"/>
  </workflow-item>
  <workflow-item name="item3" type="end" end-mode="0">
    <position y="109.04545454545453" x="664.5"/>
  </workflow-item>
  <workflow-item name="item21" out-name="item24" type="task">
    <display-name><![CDATA[Status Success]]></display-name>
    <script encoded="false"><![CDATA[STATUS = "Success";
eventOut = "Migrate VM";
eventDetails = "VM successfully migrated";
severity = "info";
]]></script>
    <in-binding/>
    <out-binding>
      <bind name="STATUS" type="string" export-name="STATUS"/>
      <bind name="eventOut" type="string" export-name="eventOut"/>
      <bind name="eventDetails" type="string" export-name="eventDetails"/>
      <bind name="severity" type="string" export-name="severity"/>
    </out-binding>
    <position y="237.22727272727272" x="1044.5"/>
  </workflow-item>
  <workflow-item name="item10" out-name="item11" catch-name="item6" throw-bind-name="eventDetails" type="task">
    <display-name><![CDATA[Build Relocate Spec Params]]></display-name>
    <script encoded="false"><![CDATA[//extract MOID from input param
//sent from vROps as datastore-name|moid
var datastoreMoid = targetDataStoreId.split('|')[1];
targetDataStoreId=datastoreMoid;

//Relocate spec requires host or pool
//just using same host as current for svmotion
targetHost = targetVM.runtime.host;

//get datastore object
targetDatastore = null;
var allDatastores = targetVcenterConnection.getAllDatastores();
for (i = 0; i < allDatastores.length; i++) {
  if (targetDataStoreId == allDatastores[i].id) {
	targetDatastore = allDatastores[i];
	System.log("Found host " + targetDatastore.name + " with MOID " + targetDatastore.id);
	break;
  }
}
if (!targetDatastore) {
  throw("No matching host ID found!");
}

]]></script>
    <in-binding>
      <bind name="targetVM" type="VC:VirtualMachine" export-name="targetVM"/>
      <bind name="targetVcenterConnection" type="VC:SdkConnection" export-name="targetVcenterConnection"/>
      <bind name="targetDataStoreId" type="string" export-name="targetDataStoreId">
        <description><![CDATA[MOID of the Datastore target]]></description>
      </bind>
    </in-binding>
    <out-binding>
      <bind name="targetDatastore" type="VC:Datastore" export-name="targetDatastore"/>
      <bind name="targetHost" type="VC:HostSystem" export-name="targetHost"/>
    </out-binding>
    <position y="9.954545454545453" x="904.5"/>
  </workflow-item>
  <workflow-item name="item30" type="end" end-mode="0">
    <position y="154.5" x="1384.5"/>
  </workflow-item>
  <workflow-item name="item0" out-name="item18" type="task">
    <display-name><![CDATA[Status Failed]]></display-name>
    <script encoded="false"><![CDATA[STATUS = "Failed";
eventOut = "Find VM by MOID";
eventDetails = "Could not find VM by MOID";
severity = "error";]]></script>
    <in-binding/>
    <out-binding>
      <bind name="STATUS" type="string" export-name="STATUS"/>
      <bind name="eventOut" type="string" export-name="eventOut"/>
      <bind name="eventDetails" type="string" export-name="eventDetails"/>
      <bind name="severity" type="string" export-name="severity"/>
    </out-binding>
    <position y="64.5" x="764.5"/>
  </workflow-item>
  <workflow-item name="item8" out-name="item24" type="task">
    <display-name><![CDATA[Status Failed]]></display-name>
    <script encoded="false"><![CDATA[STATUS = "Failed";
eventOut = "Relocate VM disks";
severity = "error";]]></script>
    <in-binding/>
    <out-binding>
      <bind name="STATUS" type="string" export-name="STATUS"/>
      <bind name="eventOut" type="string" export-name="eventOut"/>
      <bind name="eventDetails" type="string" export-name="eventDetails"/>
      <bind name="severity" type="string" export-name="severity"/>
    </out-binding>
    <position y="146.3181818181818" x="1064.5"/>
  </workflow-item>
  <workflow-item name="item6" out-name="item24" type="task">
    <display-name><![CDATA[Status Failed]]></display-name>
    <script encoded="false"><![CDATA[STATUS = "Failed";
eventOut = "Validate VM Host Target";
eventDetails = "Target Host ID Invalid or Not Found";
severity = "error";]]></script>
    <in-binding/>
    <out-binding>
      <bind name="STATUS" type="string" export-name="STATUS"/>
      <bind name="eventOut" type="string" export-name="eventOut"/>
      <bind name="eventDetails" type="string" export-name="eventDetails"/>
      <bind name="severity" type="string" export-name="severity"/>
    </out-binding>
    <position y="9.954545454545453" x="1044.5"/>
  </workflow-item>
  <workflow-item name="item7" out-name="item12" type="link" linked-workflow-id="12e3b318-41ad-4e7a-9ac9-2ef703e81d4f">
    <display-name><![CDATA[Get vCenter Connection by UUID]]></display-name>
    <in-binding>
      <bind name="targetVcenterUuid" type="string" export-name="targetvCenteruuid"/>
    </in-binding>
    <out-binding>
      <bind name="targetVcenterConnection" type="VC:SdkConnection" export-name="targetVcenterConnection"/>
    </out-binding>
    <position y="9.954545454545453" x="524.5"/>
  </workflow-item>
  <workflow-item name="item11" out-name="item21" catch-name="item8" throw-bind-name="eventDetails" type="link" linked-workflow-id="978eaa4a-1b33-40df-b929-6909e84cd9d2">
    <display-name><![CDATA[sVmotion Relocate virtual machine disks]]></display-name>
    <in-binding>
      <bind name="vm" type="VC:VirtualMachine" export-name="targetVM">
        <description><![CDATA[Virtual machine to relocate to another host or datastore]]></description>
      </bind>
      <bind name="datastore" type="VC:Datastore" export-name="targetDatastore">
        <description><![CDATA[Datastore in which to relocate the virtual machine (optional)]]></description>
      </bind>
      <bind name="host" type="VC:HostSystem" export-name="targetHost">
        <description><![CDATA[Destination host for the virtual machine (optional)]]></description>
      </bind>
      <bind name="pool" type="VC:ResourcePool" explicitly-not-bound="true" export-name="NULL">
        <description><![CDATA[Resource pool to which to attach the virtual machine (Optional)]]></description>
      </bind>
      <bind name="transform" type="VC:VirtualMachineRelocateTransformation" explicitly-not-bound="true" export-name="NULL">
        <description><![CDATA[Transformation to perform on the disks (optional)]]></description>
      </bind>
    </in-binding>
    <out-binding/>
    <description><![CDATA[Relocates virtual machine disks to another host or datastore while the virtual machine is powered off by using the RelocateVM_Task operation from the vSphere API.]]></description>
    <position y="155.4090909090909" x="905.0"/>
  </workflow-item>
  <presentation>
    <p-param name="correlationId">
      <desc><![CDATA[correlationId]]></desc>
      <p-qual kind="static" name="mandatory" type="boolean"><![CDATA[false]]></p-qual>
    </p-param>
    <p-param name="targetId">
      <desc><![CDATA[targetId]]></desc>
    </p-param>
    <p-param name="targetvCenteruuid">
      <desc><![CDATA[UUID of the vCenter where the target VM is located]]></desc>
    </p-param>
    <p-param name="targetDataStoreId">
      <desc><![CDATA[MOID of the Datastore for migration target (workflow expects name|datastore-nnn format from vC Ops)]]></desc>
    </p-param>
  </presentation>
</workflow>